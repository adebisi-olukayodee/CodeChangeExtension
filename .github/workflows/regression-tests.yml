name: Regression Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  regression-tests:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Compile regression runner
        run: npm run compile:regression
      
      - name: Run regression tests
        run: npm run regression
        continue-on-error: true
      
      - name: Run test assertions
        run: |
          npm run test:regression:date-fns
          npm run test:regression:zod
          npm run test:regression:axios
          npm run test:regression:tanstack-query || echo "tanstack-query test not yet promoted"
          npm run test:regression:rxjs || echo "rxjs test not yet promoted"
          npm run test:regression:redux-toolkit || echo "redux-toolkit test not yet promoted"
          npm run test:regression:trpc || echo "trpc test not yet promoted"
          npm run test:regression:chalk || echo "chalk test not yet promoted"
          npm run test:regression:lodash || echo "lodash test not yet promoted"
          npm run test:regression:express || echo "express test not yet promoted"
        continue-on-error: true
      
      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: regression-results
          path: |
            regressions/out/*.actual.json
            regressions/out/*.diff
          retention-days: 7
      
      - name: Check test results
        run: |
          if [ -f regressions/out/*.actual.json ]; then
            echo "Regression tests completed. Check artifacts for details."
          else
            echo "No regression results found."
            exit 1
          fi





